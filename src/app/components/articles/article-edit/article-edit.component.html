<cos-comment-edit [userInfo]="userInfo"></cos-comment-edit>
<cos-comment-list [userInfo]="userInfo"
  [parentKey]="articleId"></cos-comment-list>
<form [formGroup]="articleEditForm"
  class="article-form">
  <h2 *ngIf="articleIsNew"
    class="page-title">
    Create New Article
  </h2>

  <section class="cover-image"
    (cosClickOut)="editCoverImage = false">
    <section class="cover-image__display">
      <div *ngIf="!articleEditForm.value.imageUrl"
        class="cover-image__placeholder">
        Upload a cover image.
      </div>
      <img *ngIf="coverImageUrl$.value"
        class="cover-image__image"
        [src]="coverImageUrl$ | async">
      <button mat-icon-button
        *ngIf="!articleIsNew"
        [ngClass]="{'active': editCoverImage}"
        type="button"
        (click)="editBody = false; editCoverImage = !editCoverImage">
        <mat-icon>{{editCoverImage ? 'clear' : 'edit'}}</mat-icon>
        <span class="tooltip">{{editCoverImage ? 'Close Image' : 'Edit Image'}}</span>
      </button>
    </section>
    <section *ngIf="editCoverImage || articleIsNew"
      class="cover-image__editor">
      <p *ngIf="coverImageUploadTask">Progress: {{coverImageUploadPercent$ | async}}% Complete</p>
      <mat-form-field>
        <label>Image Alt Description</label>
        <input #imageAlt
          matInput
          type="text"
          formControlName="imageAlt"
          maxlength="100">
        <mat-hint align="end">{{imageAlt.value.length}} / 100</mat-hint>
      </mat-form-field>
      <div class="file-input flex-center-align">
        <input accept="image/*"
          type="file"
          (change)="onSelectCoverImage($event)">
      </div>
    </section>
  </section>

  <section class="title"
    (cosClickOut)="editTitle = false">
    <h2 *ngIf="!editTitle && !articleIsNew"
      class="static-display">
      {{articleEditForm.value.title}}
    </h2>
    <mat-form-field *ngIf="editTitle || articleIsNew">
      <h2><input #title
          matInput
          type="text"
          formControlName="title"
          maxlength="100"
          required>
      </h2>
      <mat-hint align="end">{{title.value.length}} / 100 </mat-hint>
      <mat-error>Please give your article a title.</mat-error>
    </mat-form-field>
    <button mat-icon-button
      *ngIf="!articleIsNew"
      [ngClass]="{'active': editTitle}"
      type="button"
      (click)="editBody = false; editTitle = !editTitle">
      <mat-icon>{{editTitle ? 'clear' : 'edit'}}</mat-icon>
      <span class="tooltip">{{editTitle ? 'Close Title' : 'Edit Title'}}</span>
    </button>
  </section>

  <section class="intro"
    (cosClickOut)="editIntro = false">
    <p *ngIf="!editIntro && !articleIsNew"
      class="static-display">
      {{articleEditForm.value.introduction}}
    </p>
    <mat-form-field *ngIf="editIntro || articleIsNew">
      <p><textarea #introduction
          matInput
          type="text"
          formControlName="introduction"
          rows="5"
          maxlength="300"
          required>
      </textarea></p>
      <mat-hint align="end">{{introduction.value.length}} / 300</mat-hint>
      <mat-error>Please tell us a little something about what this article is about.</mat-error>
    </mat-form-field>
    <button mat-icon-button
      *ngIf="!articleIsNew"
      [ngClass]="{'active': editIntro}"
      type="button"
      (click)="editBody = false; editIntro = !editIntro">
      <mat-icon>{{editIntro ? 'clear' : 'edit'}}</mat-icon>
      <span class="tooltip">{{editIntro ? 'Close Intro' : 'Edit Intro'}}</span>
    </button>
  </section>

  <p *ngIf="articleEditForm.value.lastUpdated"
    class="edit-date">Last Updated: {{articleEditForm.value.lastUpdated.toDate() | date }}</p>

  <section class="ckeditor"
    [ngClass]="{'expand': editBody || articleIsNew, 'not-editable': !editBody}">
    <div class="ckeditor-interior"
      [ngClass]="{'border': editBody || articleIsNew}">
      <button *ngIf="!articleIsNew"
        [ngClass]="{'active': editBody}"
        type="button"
        (click)="editBody = !editBody">
        {{editBody ? 'Close Body' : 'Edit Body'}}
      </button>
      <ckeditor formControlName="body"
        [editor]="ckeditor"
        [config]="ckeditorConfig"
        [disabled]="!editBody && !articleIsNew">
      </ckeditor>
    </div>
  </section>

  <section class="tags"
    (cosClickOut)="editTags = false">
    <h3>Tags</h3>
    <p *ngIf="articleEditForm.value.tags.length === 0 && !editTags">This article has no tags.</p>
    <mat-chip-list *ngIf="!editTags && !articleIsNew">
      <mat-chip *ngFor="let articleTag of articleEditForm.value.tags">{{articleTag}}</mat-chip>
    </mat-chip-list>

    <mat-form-field *ngIf="editTags || articleIsNew">
      <mat-chip-list #chipList>
        <mat-chip *ngFor="let articleTag of articleEditForm.value.tags"
          (removed)="removeTag(articleTag)">
          {{articleTag}}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>
        <input #tagInput
          [ngClass]="{'error': isInvalidTagInput(tagInput.value)}"
          [matChipInputFor]="chipList"
          [matChipInputSeparatorKeyCodes]="matChipInputSeparatorKeyCodes"
          [matChipInputAddOnBlur]="true"
          (matChipInputTokenEnd)="isInvalidTagInput(tagInput.value) ? null : addTag($event)">
      </mat-chip-list>
      <mat-hint [ngClass]="{'error': isInvalidTagInput(tagInput.value)}">
        Add new tags using alphanumeric characters and spaces only, then press ENTER to add tag.
      </mat-hint>
    </mat-form-field>
    <button mat-icon-button
      *ngIf="!articleIsNew"
      [ngClass]="{'active': editTags}"
      type="button"
      (click)="editBody = false; editTags = !editTags">
      <mat-icon>{{editTags ? 'clear' : 'edit'}}</mat-icon>
      <span class="tooltip">{{editTags ? 'Close Tags' : 'Edit Tags'}}</span>
    </button>
  </section>

  <section *ngIf="articleHasUnsavedChanges()"
    class="flex-center-justify">
    <button class="accent-2"
      type="button"
      [disabled]="!articleEditForm.valid"
      (click)="saveChanges()">
      Save Article
    </button>
  </section>
</form>
